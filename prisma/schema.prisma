// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Table des dossiers clients (200+ entreprises)
model Client {
  id              String    @id @default(cuid())
  numDossier      String    @unique // Numéro unique du dossier (indexé)
  raisonSociale   String    // Nom de la société
  adresse         String?   // Adresse complète
  siret           String?   // Numéro SIRET
  codeNaf         String?   // Code NAF/APE
  centre          String?   // Centre de gestion
  periode         String?   // Période comptable
  domaineActivite String?   // Domaine d'activité
  emailContact    String?   // Email de contact (optionnel)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  factures        Facture[] // Relation avec les factures

  @@index([numDossier])
  @@index([raisonSociale])
}

// Table des factures
model Facture {
  id                String        @id @default(cuid())
  numeroSequentiel  Int           @unique // Numéro séquentiel auto-incrémenté (UNIQUE)
  prefixe           String        @default("FA-2026-") // Préfixe de la facture
  numeroComplet     String        @unique // Numéro complet formaté (FA-2026-0001) (UNIQUE)
  date              DateTime      @default(now())
  
  // Montants calculés
  sousTotal         Float         // Sous-total avant réduction
  reduction         Float         @default(0) // Montant de la réduction
  montantHT         Float         // Montant HT après réduction
  tauxTVA           Float         @default(20.0) // Taux de TVA (20%)
  montantTVA        Float         // Montant de la TVA
  montantTTC        Float         // Montant toutes taxes comprises
  
  // Stripe
  stripePaymentLink String?       // URL du lien de paiement Stripe
  stripePaymentId   String?       // ID du paiement Stripe
  statut            String        @default("EN_ATTENTE") // EN_ATTENTE, PAYEE, ANNULEE
  
  // Relations
  clientId          String        // Relation avec le client
  client            Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  lignes            LigneFacture[] // Lignes de détail
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([numeroSequentiel])
  @@index([clientId])
  @@index([statut])
}

// Table des lignes de facture (détails)
model LigneFacture {
  id          String   @id @default(cuid())
  description String   // Ex: "Fiche de paie"
  quantite    Int      @default(1) // Ex: 5
  prixUnitaire Float   // Ex: 30.00
  montant     Float    // quantite * prixUnitaire
  
  factureId   String
  facture     Facture  @relation(fields: [factureId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@index([factureId])
}

// Table de séquence pour garantir l'unicité des numéros de facture
model Sequence {
  id            String   @id @default("FACTURE_SEQ")
  dernierNumero Int      @default(0) // Dernier numéro utilisé
  annee         Int      @default(2026) // Année en cours
  updatedAt     DateTime @updatedAt
}
